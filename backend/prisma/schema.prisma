generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Client {
  id                String             @id @default(uuid())
  name              String
  razaoSocial       String?
  cnpj_cpf          String             @unique
  dataCriacao       String?
  status            String             @default("ativado")
  inscricaoEstadual String?
  emailPrincipal    String?
  telefonePrincipal String?
  cep               String?
  estado            String?
  cidade            String?
  endereco          String?
  numero            String?
  bairro            String?
  complemento       String?
  nomeContato       String?
  emailContato      String?
  dataAniversario   String?
  observacoes       String?
  totalVendas       Decimal?           @db.Decimal(10, 2)
  dataUltimaVenda   String?
  salesCount        Int?               @default(0)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  packages          ClientPackage[]
  orders            Order[]
  recurringServices RecurringService[]

  @@index([name])
  @@index([razaoSocial])
}

model Order {
  id                      String         @id @default(uuid())
  sequentialId            Int            @unique @default(autoincrement())
  date                    DateTime       @default(now())
  clientId                String
  title                   String
  fileName                String?
  locutor                 String
  locutorId               String?
  tipo                    String
  cacheValor              Decimal        @db.Decimal(10, 2)
  vendaValor              Decimal        @db.Decimal(10, 2)
  comentarios             String?
  status                  String         @default("PEDIDO")
  urgency                 String         @default("NORMAL")
  numeroVenda             Int?           @unique
  faturado                Boolean        @default(false)
  entregue                Boolean        @default(false)
  dispensaNF              Boolean        @default(false)
  emiteBoleto             Boolean        @default(false)
  dataFaturar             DateTime?
  vencimento              DateTime?
  pago                    Boolean        @default(false)
  statusEnvio             String         @default("PENDENTE")
  createdAt               DateTime       @default(now())
  updatedAt               DateTime       @updatedAt
  pendenciaFinanceiro     Boolean        @default(false)
  pendenciaMotivo         String?
  arquivoOS               String?
  costPerCreditSnapshot   Decimal?       @db.Decimal(10, 2)
  creditsConsumed         Int            @default(0)
  numeroOS                String?
  serviceType             String?
  cachePago               Boolean        @default(false)
  supplierId              String?
  packageId               String?
  wasReopened             Boolean        @default(false)
  isCachePrePaid          Boolean        @default(false)
  isBonus                 Boolean        @default(false)
  consumptionId           String?
  packageName             String?
  cachePaymentDate        DateTime?
  cacheBank               String?
  creditsConsumedSupplier Int            @default(0)
  hasCommission           Boolean        @default(false)
  packageBilling          ClientPackage? @relation("PackageBilling")
  client                  Client         @relation(fields: [clientId], references: [id])
  locutorObj              Locutor?       @relation(fields: [locutorId], references: [id])
  package                 ClientPackage?    @relation("PackageOrders", fields: [packageId], references: [id])
  supplier                Supplier?         @relation(fields: [supplierId], references: [id])
  commissions             OrderCommission[]

  @@index([date])
  @@index([status])
  @@index([faturado])
  @@index([clientId])
}

model Locutor {
  id              String     @id @default(uuid())
  name            String
  realName        String?
  phone           String?
  email           String?
  status          String     @default("DISPONIVEL")
  reelsUrl        String?
  priceOff        Decimal    @default(0) @db.Decimal(10, 2)
  priceProduzido  Decimal    @default(0) @db.Decimal(10, 2)
  chavePix        String?
  tipoChavePix    String?
  banco           String?
  description     String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  valorFixoMensal Decimal?   @db.Decimal(10, 2)
  orders          Order[]
  suppliers       Supplier[] @relation("LocutorSuppliers")
}

model ServiceType {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String?
  role      Role     @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tierId               String?
  tier                 Tier?             @relation(fields: [tierId], references: [id])
  isCommissionEligible Boolean           @default(false)
  commissions          OrderCommission[]
}

model Supplier {
  id        String          @id @default(uuid())
  name      String          @unique
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  packages  CreditPackage[]
  orders    Order[]
  locutores Locutor[]       @relation("LocutorSuppliers")
}

model CreditPackage {
  id            String   @id @default(uuid())
  supplierId    String
  name          String
  price         Decimal  @db.Decimal(10, 2)
  credits       Int
  costPerCredit Decimal  @db.Decimal(10, 4)
  purchaseDate  DateTime @default(now())
  createdAt     DateTime @default(now())
  supplier      Supplier @relation(fields: [supplierId], references: [id])
}

model Tier {
  id                 String   @id @default(uuid())
  name               String   @unique
  accessDashboard    Boolean  @default(false)
  accessPedidos      Boolean  @default(false)
  accessClientes     Boolean  @default(false)
  accessLocutores    Boolean  @default(false)
  accessFornecedores Boolean  @default(false)
  accessFaturamento  Boolean  @default(false)
  accessRelatorios   Boolean  @default(false)
  accessUsuarios     Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  accessPacotes      Boolean  @default(false)
  users              User[]
}

model BackupConfig {
  id                String           @id @default("default")
  endpoint          String?
  accessKey         String?
  secretKey         String?
  bucket            String?
  region            String?          @default("us-east-1")
  cronSchedule      String?          @default("0 3 * * *")
  keepDays          Int              @default(7)
  enabled           Boolean          @default(false)
  updatedAt         DateTime         @updatedAt
  folderId          String?
  serviceAccountKey String?
  schedules         BackupSchedule[]
}

model BackupSchedule {
  id        String       @id @default(uuid())
  configId  String       @default("default")
  hour      Int
  minute    Int
  days      String
  timezone  String       @default("America/Sao_Paulo")
  enabled   Boolean      @default(true)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  config    BackupConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
}

model BackupLog {
  id        String   @id @default(uuid())
  filename  String
  size      BigInt?
  status    String
  error     String?
  createdAt DateTime @default(now())
}

model ClientPackage {
  id             String      @id @default(uuid())
  clientId       String
  name           String
  type           PackageType
  fixedFee       Decimal     @db.Decimal(10, 2)
  audioLimit     Int         @default(0)
  usedAudios     Int         @default(0)
  extraAudioFee  Decimal     @default(0) @db.Decimal(10, 2)
  startDate      DateTime
  endDate        DateTime
  active         Boolean     @default(true)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  autoRenewal    Boolean     @default(false)
  billingOrderId String?     @unique
  clientCode     String?
  billingOrder   Order?      @relation("PackageBilling", fields: [billingOrderId], references: [id])
  client         Client      @relation(fields: [clientId], references: [id])
  orders         Order[]     @relation("PackageOrders")

  @@index([clientId])
  @@index([active])
}

model RecurringService {
  id            String                @id @default(uuid())
  name          String
  clientId      String
  value         Decimal               @db.Decimal(10, 2)
  recurrence    ServiceRecurrence
  isAutomatic   Boolean               @default(true)
  hasCommission Boolean               @default(false)
  autoBilling   Boolean               @default(false)
  active        Boolean               @default(true)
  startDate     DateTime              @default(now())
  nextExecution DateTime
  lastExecution DateTime?
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  client        Client                @relation(fields: [clientId], references: [id])
  logs          RecurringServiceLog[]

  @@index([clientId])
  @@index([active])
}

model RecurringServiceLog {
  id               String           @id @default(uuid())
  serviceId        String
  status           String
  message          String?
  generatedOrderId String?
  executionDate    DateTime         @default(now())
  service          RecurringService @relation(fields: [serviceId], references: [id])
}

model FinancialConfig {
  id             String   @id @default("default")
  taxRate        Decimal  @default(0.10) @db.Decimal(5, 4)
  commissionRate Decimal  @default(0.04) @db.Decimal(5, 4)
  updatedAt      DateTime @updatedAt
}

model OrderCommission {
  id        String   @id @default(uuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  percent   Decimal  @db.Decimal(5, 4) // Fração da comissão total (ex: 0.50 = 50%)
  value     Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())

  @@unique([orderId, userId])
}

model Notification {
  id         String   @id @default(uuid())
  type       String   // 'RENEWAL', 'BILLING', 'SYSTEM'
  title      String
  message    String
  targetRole String   // 'ATENDIMENTO', 'FINANCEIRO', 'ADMIN'
  link       String?
  read       Boolean  @default(false)
  createdAt  DateTime @default(now())
}

enum Role {
  ADMIN
  USER
}

enum PackageType {
  FIXO_ILIMITADO
  FIXO_COM_LIMITE
  FIXO_COM_LIMITE_VENCIMENTO
  FIXO_SOB_DEMANDA
  SOB_DEMANDA_AVULSO
}

enum ServiceRecurrence {
  WEEKLY
  BIWEEKLY
  MONTHLY
  BIMONTHLY
  QUARTERLY
  SEMIANNUAL
  ANNUAL
}
